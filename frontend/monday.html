<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Monday-like Tree Grid Prototype</title>
    <style>
      :root {
        --bg: #f3f4f6;
        --card: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --line: #e5e7eb;
        --head: #f8fafc;
        --hover: #ffedd5; /* opaque hover to avoid bleed-through under sticky */
        --indent1: 6px;
        --indent2: 28px;

        --ok: #10b981;
        --warn: #fb923c;
        --bad: #ef4444;
        --idle: #e5e7eb;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        font-size: 12px;
        color: var(--text);
        padding: 24px;
      }

      .wrap {
        max-width: 1200px;
        margin: 0 auto;
      }

      .card {
        background: var(--card);
        border: 1px solid var(--line);
        border-radius: 14px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
        overflow: hidden;
      }

      .card-header {
        padding: 16px 18px;
        border-bottom: 1px solid var(--line);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .card-header h2 {
        margin: 0;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #1f2a6d;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
      }

      .table-wrap {
        overflow: auto;
      }

      table {
        border-collapse: separate;
        border-spacing: 0;
        width: max-content;
        min-width: 100%;
        table-layout: fixed;
      }

      thead th {
        position: sticky;
        top: 0;
        z-index: 50;
        background: var(--head);
        border-bottom: 1px solid var(--line);
        font-size: 12px;
        font-weight: 700;
        color: #111827;
        text-align: left;
        padding: 12px 8px;
        white-space: nowrap;
      }

      tbody td {
        border-bottom: 1px solid var(--line);
        padding: 12px 10px;
        font-size: 12px;
        vertical-align: top;
        background: #fff;
      }

      tbody tr:hover td {
        background: var(--hover);
      }
      /* expanded box cells must also take hover (tree-box background is defined later) */
      tbody tr:hover td.tree-box {
        background: var(--hover);
      }

      /* tree-empty must stay opaque (prevents bleed/lines) */
      tbody tr:hover td.tree-empty {
        background: #fff !important;
      }

      /* widths */
      .w-pin {
        width: 72px;
        min-width: 72px;
        max-width: 72px;
        white-space: nowrap;
      }
      .w-title {
        width: 260px;
        min-width: 260px;
        max-width: 260px;
      }
      .w-client {
        width: 150px;
        min-width: 150px;
        max-width: 150px;
      }
      .w-cons {
        width: 120px;
        min-width: 120px;
        max-width: 120px;
      }
      .w-loc {
        width: 120px;
        min-width: 120px;
        max-width: 120px;
      }
      .w-curr {
        width: 100px;
        min-width: 100px;
        max-width: 100px;
        white-space: nowrap;
      }
      .w-stage {
        width: 135px;
        min-width: 135px;
        max-width: 135px;
        white-space: nowrap;
      }
      .w-status {
        width: 150px;
        min-width: 150px;
        max-width: 150px;
        white-space: nowrap;
      }
      .w-date {
        width: 100px;
        min-width: 100px;
        max-width: 100px;
        white-space: nowrap;
      }
      .w-overdue {
        width: 90px;
        min-width: 90px;
        max-width: 90px;
        white-space: nowrap;
      }
      .w-remarks {
        width: 170px;
        min-width: 170px;
      }
      .nowrap {
        white-space: nowrap;
      }
      .wraptext {
        white-space: normal;
        overflow-wrap: anywhere;
        word-break: break-word;
      }

      /* sticky first two columns */
      .sticky {
        position: sticky;
        left: 0;
        z-index: 80;
        background: #fff;
        background-clip: padding-box;
      }
      .sticky2 {
        position: sticky;
        left: 72px; /* PIN width */
        z-index: 80;
        background: #fff;
        background-clip: padding-box;
      }
      thead .sticky,
      thead .sticky2 {
        background: var(--head);
        z-index: 60;
      }
      /* sticky cells must be opaque to avoid bleed-through */
      td.sticky.tree-box,
      td.sticky2.tree-box {
        background: #f9fafb;
      }
      td.sticky,
      td.sticky2 {
        background: #fff;
      }
      /* sticky cells should also show hover (opaque) */
      tbody tr:hover td.sticky,
      tbody tr:hover td.sticky2 {
        background: var(--hover) !important;
      }
      tbody tr:hover td.sticky.tree-box,
      tbody tr:hover td.sticky2.tree-box {
        background: var(--hover) !important;
      }
      /* subtle divider after sticky2 like monday */
      .divider-shadow {
        box-shadow: 2px 0 0 rgba(229, 231, 235, 1);
      }

      /* avoid clipping for sticky cells (expander circle) */
      td.sticky,
      td.sticky2 {
        overflow: visible;
      }
      .pin-cell {
        overflow: visible;
      }

      /* expanded grid header row (like monday subitems header) */
      .subhead-row td {
        font-size: 12px;
        font-weight: 800;
        color: #374151;
        text-transform: none; /* keep Capital Case */
        letter-spacing: 0.01em;
        padding-top: 10px;
        padding-bottom: 10px;
      }
      /* keep header hover from tinting weirdly */
      tr.subhead-row:hover td {
        background: transparent;
      }
      tr.subhead-row:hover td.tree-box {
        background: #f9fafb;
      }
      /* force subhead row to ignore the global tbody hover styling */
      tbody tr.subhead-row:hover td,
      tbody tr.subhead-row:hover td.tree-box,
      tbody tr.subhead-row td,
      tbody tr.subhead-row td.tree-box {
        background: #f9fafb !important; /* keep consistent header background */
      }
      tbody tr.subhead-row:hover td.sticky,
      tbody tr.subhead-row:hover td.sticky2,
      tbody tr.subhead-row td.sticky,
      tbody tr.subhead-row td.sticky2 {
        background: #f9fafb !important;
      }
      tbody tr.subhead-row:hover td.tree-empty,
      tbody tr.subhead-row td.tree-empty {
        background: #fff !important;
      }

      /* expander */
      .exp-btn {
        width: 20px;
        height: 20px;
        border: 1px solid var(--line);
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #ffffff;
        color: #6b7280;
        cursor: pointer;
        flex: 0 0 auto;
        transition: background 120ms ease, border-color 120ms ease;
      }
      .exp-btn:hover {
        background: #f9fafb;
        border-color: #d1d5db;
      }
      .exp-btn:active {
        background: #f3f4f6;
      }
      .chev {
        width: 10px;
        height: 10px;
        display: inline-block;
        transform: rotate(0deg);
        transition: transform 160ms ease;
      }
      .is-open .chev {
        transform: rotate(180deg);
      }

      /* tree rows */
      .row-stage td {
        background: #f1f5f9;
      }
      .row-step td {
        background: #f8fafc;
      }

      /* shallower indentation (your request) */
      .indent-1 {
        padding-left: var(--indent1);
      }
      .indent-2 {
        padding-left: var(--indent2);
      }

      /* group block look (subitems area) */
      .gap-row td {
        height: 10px;
        padding: 0 !important;
        border: 0 !important;
        background: transparent !important;
      }

      /* thin separator line between sections */
      .sep-row td {
        height: 10px;
        padding: 0 !important;
        background: transparent !important;
        border: 0 !important;
        border-bottom: 1px solid var(--line) !important;
      }

      /* ---------------------------------------------------------
         Subitems bordered box spans multiple columns:
         Project Title ... Notes (aligned borders)
         --------------------------------------------------------- */
      .tree-empty {
        /* visually empty + opaque, and NO grid lines */
        background: #fff !important;
        border-bottom: 0 !important;
        border-left: 0 !important;
        border-top: 0 !important;
      }
      tbody tr:hover td.tree-empty {
        background: #fff !important;
        border-bottom: 0 !important;
        border-left: 0 !important;
        border-top: 0 !important;
      }

      /* All cells that belong to the subitems box */
      .tree-box {
        background: #f9fafb; /* opaque */
        border-bottom: 1px solid rgba(229, 231, 235, 0.95);
        border-top: 0;
        background-clip: padding-box;
      }
      .row-stage td.tree-box {
        background: #f1f5f9;
      }
      .row-step td.tree-box {
        background: #f8fafc;
      }

      /* left boundary of the box */
      .tree-box-first {
        border-left: 1px solid rgba(229, 231, 235, 0.95);
      }

      /* right boundary of the box */
      .tree-box-last {
        border-right: 1px solid rgba(229, 231, 235, 0.95);
      }

      /* top edge + rounded corners */
      .block-start .tree-box {
        border-top: 1px solid rgba(209, 213, 219, 1);
      }
      .block-start .tree-box-first {
        border-top-left-radius: 10px;
      }
      .block-start .tree-box-last {
        border-top-right-radius: 10px;
      }

      /* bottom rounded corners */
      .block-end .tree-box-first {
        border-bottom-left-radius: 10px;
      }
      .block-end .tree-box-last {
        border-bottom-right-radius: 10px;
      }

      /* also round + border the left empty sticky cell to avoid corner seams */
      /* keep the frozen empty column fully plain (no borders/radius) */
      td.sticky.tree-empty,
      td.sticky2.tree-empty {
        z-index: 90;
        background: #fff !important;
        border: 0 !important;
      }

      /* clip tiny corner border artifacts (seen when scrolling) */
      .block-start .tree-box-first,
      .block-start .tree-box-last,
      .block-end .tree-box-first,
      .block-end .tree-box-last {
        overflow: hidden;
        background-clip: padding-box;
      }

      /* ---------------------------------------------------------
         Pills (Status + Overdue) — Monday-like
         --------------------------------------------------------- */
      .pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 10px;
        border-radius: 14px;
        font-size: 12px; /* match table body */
        font-weight: 800;
        line-height: 1;
        white-space: nowrap;
      }

      /* status pills */
      .p-init {
        background: #e5e7eb;
        color: #374151;
      }
      .p-prog {
        background: #fb923c;
        color: #ffffff;
      }
      .p-clar {
        background: #60a5fa;
        color: #ffffff;
      }
      .p-rev {
        background: #a78bfa;
        color: #ffffff;
      }

      /* overdue pills */
      .p-ok {
        background: #10b981;
        color: #ffffff;
        min-width: 64px;
        padding: 4px 10px;
      }
      .p-warn {
        background: #fbbf24;
        color: #111827;
        min-width: 64px;
        padding: 4px 10px;
      }
      .p-bad {
        background: #ef4444;
        color: #ffffff;
        min-width: 64px;
        padding: 4px 10px;
      }

      /* due-in pills */
      .di-over {
        background: #ef4444;
        color: #ffffff;
      }
      .di-ok {
        background: #10b981;
        color: #ffffff;
      }
      .di-warn {
        background: #fbbf24;
        color: #111827;
      }
      .due-in-cell {
        overflow: hidden;
      }
      .due-in-pill {
        min-width: 72px;
      }

      .pic {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
      }
      .pic-avatar {
        width: 22px;
        height: 22px;
        border-radius: 999px;
        background: #e5e7eb;
        color: #111827;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        flex: 0 0 auto;
      }
      .subtext {
        color: #374151;
        font-weight: 600;
      }
      .attach {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        width: 100%;
      }
      .attach:hover {
        cursor: pointer;
      }
      .attach-icon {
        width: 14px;
        height: 14px;
        color: #6b7280;
        flex: 0 0 auto;
      }
      .attach-text {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        min-width: 0;
        flex: 1;
      }
      .progress {
        width: 100%;
        height: 16px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
        position: relative;
      }
      .progress-fill {
        height: 100%;
        border-radius: 999px;
      }
      .progress-label {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: 800;
        color: #111827;
        pointer-events: none;
      }
      .pr-ok {
        background: #10b981;
      }
      .pr-warn {
        background: #fbbf24;
      }
      .pr-bad {
        background: #ef4444;
      }

      /* badge */
      .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 800;
        min-width: 88px;
      }
      .b-ok {
        background: var(--ok);
        color: #fff;
      }
      .b-warn {
        background: var(--warn);
        color: #fff;
      }
      .b-bad {
        background: var(--bad);
        color: #fff;
      }
      .b-idle {
        background: var(--idle);
        color: #6b7280;
      }

      /* click affordance only for title */
      .title-link {
        cursor: pointer;
        font-weight: 700;
      }
      .title-link:hover {
        text-decoration: underline;
        text-underline-offset: 2px;
      }
      .pin-cell {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .stage-cell {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .arrow {
        color: #9ca3af;
        display: inline-block;
        width: 16px; /* keeps step text aligned */
      }
      .add-item {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #6b7280;
        font-weight: 600;
        cursor: pointer;
      }
      .add-circle {
        width: 18px;
        height: 18px;
        border: 1px solid #d1d5db;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        line-height: 1;
        background: #ffffff;
        color: #6b7280;
        flex: 0 0 auto;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card">
        <div class="card-header">
          <h2>Tenders List (Prototype)</h2>
        </div>

        <div class="table-wrap">
          <table id="grid">
            <thead>
              <tr>
                <th class="w-pin sticky">PIN</th>
                <th class="w-title sticky2 divider-shadow">Project Title</th>
                <th class="w-client">Client</th>
                <th class="w-cons">Consortium</th>
                <th class="w-loc">Location</th>
                <th class="w-curr">Currency</th>
                <th class="nowrap">Est. Value</th>
                <th class="w-stage">Stage</th>
                <th class="w-status">Status</th>
                <th class="w-date">Start Date</th>
                <th class="w-date">Due Date</th>
                <th class="w-overdue">Overdue</th>
                <th class="w-remarks">Remarks</th>
              </tr>
            </thead>
            <tbody id="body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <script>
      // -----------------------------
      // Dummy data (parent rows)
      // -----------------------------
      const TENDERS = [
        {
          PIN: "K079",
          ProjectTitle: "VALVE KEBUTUHAN RUTIN DAN OVERHAUL",
          Client: "PT Kilang Pertamina Internasional RU VI Balongan",
          Consortium: "N/A",
          Location: "Balongan, Jawa Barat",
          Currency: "IDR",
          EstimatedValue: "818,835,535",
          PipelineStage: "Proposal",
          StageStep: "On Progress",
          RegDate: "03/01/2026",
          PQDate: "10/01/2026",
          ProposalDate: "20/01/2026",
          NegoDate: "",
          AwardDate: "",
          Remarks: "Waiting PQ invitation / documents",
          OutcomeStatus: "Open",
        },
        {
          PIN: "K080",
          ProjectTitle: "VALVE PROJECT CAPEX 2025",
          Client: "PT Kilang Pertamina Internasional RU VI Balongan",
          Consortium: "N/A",
          Location: "Balongan, Jawa Barat",
          Currency: "IDR",
          EstimatedValue: "41,504,163,673",
          PipelineStage: "Registration",
          StageStep: "Under Evaluation",
          RegDate: "05/01/2026",
          PQDate: "",
          ProposalDate: "",
          NegoDate: "",
          AwardDate: "",
          Remarks: "Submitted registration, waiting evaluation",
          OutcomeStatus: "Open",
        },
      ];

      const STAGES = [
        { name: "Registration", dateKey: "RegDate" },
        { name: "Pre-Qualification", dateKey: "PQDate" },
        { name: "Proposal", dateKey: "ProposalDate" },
        { name: "Negotiation", dateKey: "NegoDate" },
        { name: "Contract", dateKey: "AwardDate" },
      ];

      const STAGE_STEPS = {
        Registration: ["Letter of Interest"],
        "Pre-Qualification": [
          "Invitation",
          "Elucidation Meeting",
          "PQ Submission",
        ],
        Proposal: [
          "Invitation",
          "Pre-Bid Meeting",
          "Site Survey",
          "Bid Submission",
        ],
        Negotiation: [],
        Contract: [],
      };
      const ADD_ITEM_STAGES = new Set([
        "Registration",
        "Pre-Qualification",
        "Proposal",
        "Negotiation",
        "Contract",
      ]);
      const DEFAULT_PIC_NAME = "Ruzia";
      const DEFAULT_NOTES = "Lorem ipsum dolor sit amet";
      const STEP_META = {
        "Letter of Intent": {
          submission: "Email",
          attachment: "Letter of Intent Submission 2026.pdf",
          progress: 100,
        },
        "Letter of Interest": {
          submission: "Email",
          attachment: "Letter of Interest Submission 2026.pdf",
          progress: 100,
        },
        Invitation: {
          submission: "",
          attachment: "Invitation Letter 2026.pdf",
          progress: 100,
        },
        "Elucidation Meeting": {
          submission: "",
          attachment: "Elucidation Meeting Minutes and Action Items 2026.pdf",
          progress: 80,
        },
        "PQ Submission": {
          submission: "Eproc",
          attachment: "PQ Submission Documents Bundle v3.zip",
          progress: 80,
        },
        "Pre-Bid Meeting": {
          submission: "",
          attachment: "Pre-Bid Meeting Agenda.pdf",
          progress: 80,
        },
        "Site Survey": {
          submission: "Offline",
          attachment: "Site Survey Report Photos 2026.pdf",
          progress: 30,
        },
        "Bid Submission": {
          submission: "",
          attachment: "Bid Submission Final Version 2026.xlsx",
          progress: 100,
        },
      };

      // State
      let expandedPIN = null; // only one open
      const expandedStage = new Set(); // keys: `${PIN}::${Stage}`

      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      function parseDMY(dateStr) {
        // expects dd/mm/yyyy
        const s = String(dateStr || "").trim();
        if (!s) return null;
        const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (!m) return null;
        const dd = Number(m[1]);
        const mm = Number(m[2]);
        const yy = Number(m[3]);
        const d = new Date(yy, mm - 1, dd);
        return Number.isNaN(d.getTime()) ? null : d;
      }

      function diffDays(startStr, endStr) {
        const a = parseDMY(startStr);
        const b = parseDMY(endStr);
        if (!a || !b) return "";
        const ms = b.getTime() - a.getTime();
        if (ms <= 0) return "";
        const days = Math.ceil(ms / (1000 * 60 * 60 * 24));
        return `${days}d`;
      }

      function dueInMeta(dueStr) {
        const due = parseDMY(dueStr);
        if (!due) return { label: "", className: "" };
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const d = new Date(due.getFullYear(), due.getMonth(), due.getDate());
        const ms = d.getTime() - today.getTime();
        const days = Math.ceil(ms / (1000 * 60 * 60 * 24));
        const absDays = Math.abs(days);
        const sign = days < 0 ? "+" : "-";
        let label = "";
        if (absDays < 7) label = `${sign}${absDays} d`;
        else label = `${sign}${Math.floor(absDays / 7)} w`;

        if (days < 0) return { label, className: "di-over" };
        if (absDays >= 7) return { label, className: "di-ok" };
        return { label, className: "di-warn" };
      }

      function dueInPill(meta) {
        if (!meta?.label) return "";
        return `<span class="pill due-in-pill ${meta.className}">${esc(
          meta.label
        )}</span>`;
      }

      function picCell(name) {
        const n = String(name || "").trim();
        if (!n) return "";
        const initial = n.slice(0, 1).toUpperCase();
        return `<span class="pic"><span class="pic-avatar">${esc(
          initial
        )}</span><span>${esc(n)}</span></span>`;
      }

      function stepMeta(stepName) {
        return STEP_META[stepName] || {};
      }

      function submissionCell(value) {
        if (!value) return "";
        return `<span class="subtext">${esc(value)}</span>`;
      }

      function attachmentCell(filename) {
        if (!filename) return "";
        return `<span class="attach" title="${esc(filename)}">
          <svg class="attach-icon" viewBox="0 0 20 20" fill="none" aria-hidden="true">
            <path d="M7 11l6-6a3 3 0 114 4l-7 7a5 5 0 11-7-7l7-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <span class="attach-text">${esc(filename)}</span>
        </span>`;
      }

      function progressClass(percent) {
        if (percent <= 30) return "pr-bad";
        if (percent <= 80) return "pr-warn";
        return "pr-ok";
      }

      function progressBar(percent) {
        if (percent === null || percent === undefined) return "";
        const safe = Math.max(0, Math.min(100, Number(percent)));
        return `<div class="progress" title="${safe}%">
          <div class="progress-fill ${progressClass(
            safe
          )}" style="width: ${safe}%;"></div>
          <span class="progress-label">${safe}%</span>
        </div>`;
      }

      function normalizeStatusLabel(stageStep) {
        const s = String(stageStep || "").trim();
        if (!s) return "On Progress";
        if (s.toLowerCase() === "under evaluation") return "Under Review";
        if (s.toLowerCase() === "under review") return "Under Review";
        if (s.toLowerCase() === "initiation") return "Initiation";
        if (s.toLowerCase() === "on progress") return "On Progress";
        if (s.toLowerCase() === "clarification") return "Clarification";
        if (s.toLowerCase() === "under evaluation") return "Under Review";
        return s; // fallback
      }

      function statusClass(label) {
        switch (label) {
          case "Initiation":
            return "p-init";
          case "Clarification":
            return "p-clar";
          case "Under Review":
            return "p-rev";
          case "On Progress":
          default:
            return "p-prog";
        }
      }

      function overdueDays(dueStr) {
        const due = parseDMY(dueStr);
        if (!due) return 0;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const d = new Date(due.getFullYear(), due.getMonth(), due.getDate());
        const ms = today.getTime() - d.getTime();
        const days = Math.floor(ms / (1000 * 60 * 60 * 24));
        return days > 0 ? days : 0;
      }

      function overdueClass(days) {
        if (days < 7) return "p-ok";
        if (days <= 14) return "p-warn";
        return "p-bad";
      }

      function computeStageEndDate(t, idx) {
        // End date = next available stage date after this stage
        for (let j = idx + 1; j < STAGES.length; j++) {
          const key = STAGES[j].dateKey;
          const v = t[key];
          if (v) return v;
        }
        return "";
      }

      function badge(status) {
        if (status === "Done") return `<span class="badge b-ok">Done</span>`;
        if (status === "Working")
          return `<span class="badge b-warn">On Progress</span>`;
        if (status === "Failed")
          return `<span class="badge b-bad">Failed</span>`;
        return `<span class="badge b-idle">&nbsp;</span>`;
      }

      function statusForStage(t, idx, activeIdx) {
        const isWon =
          t.OutcomeStatus === "Won" || t.PipelineStage === "Contract";
        const isLost =
          t.OutcomeStatus === "Lost" || t.PipelineStage === "Failed";

        if (isWon) return "Done";
        if (isLost) {
          if (idx < activeIdx) return "Done";
          if (idx === activeIdx) return "Failed";
          return "";
        }
        if (idx < activeIdx) return "Done";
        if (idx === activeIdx) return "Working";
        return "";
      }

      function activeStageIndex(t) {
        const names = STAGES.map((s) => s.name);
        let idx = names.indexOf(t.PipelineStage);
        if (idx >= 0) return idx;

        // fallback: last date filled
        let last = 0;
        STAGES.forEach((s, i) => {
          if (t[s.dateKey]) last = i;
        });
        return last;
      }

      function render() {
        const tbody = document.getElementById("body");
        tbody.innerHTML = "";

        TENDERS.forEach((t) => {
          // parent row
          const parent = document.createElement("tr");
          const isOpen = expandedPIN === t.PIN;
          parent.className = isOpen ? "is-open" : "";

          parent.innerHTML = `
            <td class="w-pin sticky">
              <div class="pin-cell">
                <span>${esc(t.PIN)}</span>
                <button class="exp-btn ${
                  isOpen ? "is-open" : ""
                }" data-pin="${esc(t.PIN)}" title="Expand">
                  <svg class="chev" viewBox="0 0 20 20" fill="none">
                    <path d="M5 8l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </td>
            <td class="w-title sticky2 divider-shadow wraptext"><span class="title-link">${esc(
              t.ProjectTitle
            )}</span></td>
            <td class="w-client wraptext">${esc(t.Client)}</td>
            <td class="w-cons wraptext">${esc(t.Consortium)}</td>
            <td class="w-loc wraptext">${esc(t.Location)}</td>
            <td class="w-curr">${esc(t.Currency)}</td>
            <td class="nowrap">${esc(t.EstimatedValue)}</td>
            <td class="w-stage">${esc(t.PipelineStage)}</td>
            <td class="w-status">
              <span class="pill ${statusClass(
                normalizeStatusLabel(t.StageStep)
              )}">${esc(normalizeStatusLabel(t.StageStep))}</span>
            </td>
            <td class="w-date">${esc(t.RegDate || "")}</td>
            <td class="w-date">${esc(
              t[STAGES[activeStageIndex(t)]?.dateKey] || ""
            )}</td>
            <td class="w-overdue">
              <span class="pill ${overdueClass(
                overdueDays(t[STAGES[activeStageIndex(t)]?.dateKey] || "")
              )}">${esc(
            overdueDays(t[STAGES[activeStageIndex(t)]?.dateKey] || "") + "d"
          )}</span>
            </td>
            <td class="w-remarks wraptext">${esc(t.Remarks)}</td>
          `;
          tbody.appendChild(parent);

          // expanded block
          if (!isOpen) return;

          // small gap like monday
          const gap = document.createElement("tr");
          gap.className = "gap-row";
          gap.innerHTML = `<td colspan="13"></td>`;
          tbody.appendChild(gap);

          // expanded header row (aligned to table columns)
          const subHead = document.createElement("tr");
          subHead.className = "subhead-row block-start";

          subHead.innerHTML = `
            <td class="w-pin sticky tree-empty"></td>

            <!-- Project Title column -->
            <td class="w-title sticky2 divider-shadow wraptext tree-box tree-box-first">Subitem</td>

            <!-- Status column -->
            <td class="w-client tree-box">Status</td>

            <!-- PIC / Start / Due In / Due Date -->
            <td class="w-cons tree-box">PIC</td>
            <td class="w-loc tree-box">Start Date</td>
            <td class="w-curr tree-box">Due In</td>
            <td class="nowrap tree-box">Due Date</td>

            <!-- Submission / Attachment / Progress -->
            <td class="w-stage tree-box">Submission</td>
            <td class="w-status tree-box">Attachment</td>
            <td class="w-date tree-box">Progress</td>

            <!-- Notes column (final) -->
            <td class="w-remarks tree-box tree-box-last notes-cell" colspan="2">Notes</td>
            <td class="w-remarks tree-empty"></td>
          `;
          tbody.appendChild(subHead);

          const activeIdx = activeStageIndex(t);

          // stage rows + step rows
          let firstRow = true;
          let lastTr = null;

          STAGES.forEach((s, idx) => {
            const key = `${t.PIN}::${s.name}`;
            const steps = STAGE_STEPS[s.name] || [];
            const hasSteps = steps.length > 0;
            const shouldShowAddItem = ADD_ITEM_STAGES.has(s.name);
            const canExpand = hasSteps || shouldShowAddItem;
            const isStageOpen = expandedStage.has(key);

            const stageTr = document.createElement("tr");
            stageTr.className = `row-stage block ${firstRow ? "" : ""}`;
            const stageStatus = statusForStage(t, idx, activeIdx);
            const stageDate = t[s.dateKey] || "";
            const stageEndDate = computeStageEndDate(t, idx);
            const stageDueIn = dueInMeta(stageEndDate);
            const stagePic = picCell(DEFAULT_PIC_NAME);
            const stageNotes = esc(DEFAULT_NOTES);

            stageTr.innerHTML = `
              <td class="w-pin sticky tree-empty"></td>

              <td class="w-title sticky2 divider-shadow wraptext tree-box tree-box-first">
                <div class="indent-1 stage-cell">
                  ${
                    canExpand
                      ? `<button class="exp-btn ${
                          isStageOpen ? "is-open" : ""
                        }" data-stage="${esc(key)}" title="Expand stage">
                          <svg class="chev" viewBox="0 0 20 20" fill="none">
                            <path d="M5 8l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          </svg>
                        </button>`
                      : `<span style="display:inline-block;width:18px;height:18px;"></span>`
                  }
                  <span>${esc(s.name)}</span>
                </div>
              </td>

              <!-- Status column -->
              <td class="w-client tree-box">${badge(stageStatus)}</td>

              <!-- PIC / Start / Due In / Due Date -->
              <td class="w-cons tree-box">${stagePic}</td>
              <td class="w-loc tree-box">${esc(stageDate)}</td>
              <td class="w-curr tree-box due-in-cell">${dueInPill(
                stageDueIn
              )}</td>
              <td class="nowrap tree-box">${esc(stageEndDate)}</td>

              <!-- Submission / Attachment / Progress -->
              <td class="w-stage tree-box"></td>
              <td class="w-status tree-box"></td>
              <td class="w-date tree-box"></td>

              <!-- Notes blank for now -->
              <td class="w-remarks tree-box tree-box-last notes-cell" colspan="2">${stageNotes}</td>
              <td class="w-remarks tree-empty"></td>
            `;
            tbody.appendChild(stageTr);
            lastTr = stageTr;
            firstRow = false;

            if (isStageOpen && hasSteps) {
              steps.forEach((stepName) => {
                const stepTr = document.createElement("tr");
                stepTr.className = "row-step block";
                const meta = stepMeta(stepName);
                const stepPic = picCell(DEFAULT_PIC_NAME);
                const stepSubmission = submissionCell(meta.submission);
                const stepAttachment = attachmentCell(meta.attachment);
                const stepProgress = progressBar(meta.progress);
                const stepNotes = esc(DEFAULT_NOTES);

                stepTr.innerHTML = `
                  <td class="w-pin sticky tree-empty"></td>

                  <!-- STEP name goes under Subitem (Project Title) -->
                  <td class="w-title sticky2 divider-shadow wraptext tree-box tree-box-first">
                    <div class="indent-2">
                      <span class="arrow">↳</span> ${esc(stepName)}
                    </div>
                  </td>

                  <!-- Status column (step) -->
                  <td class="w-client tree-box">${badge("")}</td>

                  <!-- PIC / Start / Due In / Due Date (blank for step) -->
                  <td class="w-cons tree-box">${stepPic}</td>
                  <td class="w-loc tree-box"></td>
                  <td class="w-curr tree-box due-in-cell"></td>
                  <td class="nowrap tree-box"></td>

                  <!-- Submission / Attachment / Progress (blank for step) -->
                  <td class="w-stage tree-box">${stepSubmission}</td>
                  <td class="w-status tree-box">${stepAttachment}</td>
                  <td class="w-date tree-box">${stepProgress}</td>

                  <!-- Notes blank -->
                  <td class="w-remarks tree-box tree-box-last notes-cell" colspan="2">${stepNotes}</td>
                  <td class="w-remarks tree-empty"></td>
                `;
                tbody.appendChild(stepTr);
                lastTr = stepTr;
              });
            }

            if (isStageOpen && shouldShowAddItem) {
              const addTr = document.createElement("tr");
              addTr.className = "row-step block";
              addTr.innerHTML = `
                  <td class="w-pin sticky tree-empty"></td>

                  <!-- Add item (after steps) -->
                  <td class="w-title sticky2 divider-shadow wraptext tree-box tree-box-first">
                    <div class="indent-2">
                      <span class="add-item">
                        <span class="add-circle">+</span>
                        <span>Add item</span>
                      </span>
                    </div>
                  </td>

                  <!-- Status column (step) -->
                  <td class="w-client tree-box"></td>

                  <!-- PIC / Start / Due In / Due Date (blank for add item) -->
                  <td class="w-cons tree-box"></td>
                  <td class="w-loc tree-box"></td>
                  <td class="w-curr tree-box due-in-cell"></td>
                  <td class="nowrap tree-box"></td>

                  <!-- Submission / Attachment / Progress (blank for add item) -->
                  <td class="w-stage tree-box"></td>
                  <td class="w-status tree-box"></td>
                  <td class="w-date tree-box"></td>

                  <!-- Notes blank -->
                  <td class="w-remarks tree-box tree-box-last notes-cell" colspan="2"></td>
                  <td class="w-remarks tree-empty"></td>
                `;
              tbody.appendChild(addTr);
              lastTr = addTr;
            }
          });

          if (lastTr) lastTr.classList.add("block-end");

          // bottom gap + separator so next parent row doesn't stick to the expanded block
          const sep = document.createElement("tr");
          sep.className = "sep-row";
          sep.innerHTML = `<td colspan="13"></td>`;
          tbody.appendChild(sep);
        });
      }

      render();

      // -----------------------------
      // Event delegation (works even after re-render)
      // -----------------------------
      document.getElementById("body").addEventListener("click", (e) => {
        const pinBtn = e.target.closest(".exp-btn[data-pin]");
        if (pinBtn) {
          e.preventDefault();
          const pin = pinBtn.dataset.pin;
          expandedStage.clear(); // reset stage expand when switching PIN
          expandedPIN = expandedPIN === pin ? null : pin;
          render();
          return;
        }

        const stageBtn = e.target.closest(".exp-btn[data-stage]");
        if (stageBtn) {
          e.preventDefault();
          const key = stageBtn.dataset.stage;
          if (expandedStage.has(key)) expandedStage.delete(key);
          else expandedStage.add(key);
          render();
        }
      });
    </script>
  </body>
</html>
